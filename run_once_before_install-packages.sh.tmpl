#!/usr/bin/env zsh

# Fail early if not running under Zsh
[[ -z "$ZSH_VERSION" ]] && return


# Utilities
log_info() {
  print -P "%F{cyan}[chez-moi]%f $1"
}

log_ok() {
  print -P "%F{green}[chez-moi]%f $1"
}

log_warn() {
  print -P "%F{yellow}[chez-moi]%f $1"
}

# --- 1. OS Detection ---
OS_TYPE="{{ .chezmoi.os }}"
echo "ğŸ” Detected OS: $OS_TYPE"

# --- 2. macOS Setup ---
{{ if eq .chezmoi.os "darwin" -}}
log_info "ğŸ Starting macOS Setup..."

# Xcode Command Line Tools
if ! xcode-select -p &> /dev/null; then
    log_info "ğŸ› ï¸  Xcode Command Line Tools not found. Installing..."
    xcode-select --install
    until xcode-select -p &> /dev/null; do sleep 5; done
    log_ok "âœ…  Xcode Command Line Tools Installed"
fi

# Homebrew
if ! command -v brew &> /dev/null; then
    log_info "ğŸº Installing Homebrew..."
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    [ -d "/opt/homebrew/bin" ] && eval "$(/opt/homebrew/bin/brew shellenv)"
    log_ok "âœ…  Homebrew Installed"
fi

# --- C. Zsh Plugins (Managed by Chezmoi) ---

PLUGIN_DIR="$HOME/.local/share/zsh-plugins"

# Define an associative array of plugins (Folder Name => GitHub URL)
declare -A ZSH_PLUGINS=(
    ["fzf-tab"]="https://github.com/Aloxaf/fzf-tab"
    ["zsh-autosuggestions"]="https://github.com/zsh-users/zsh-autosuggestions"
    ["zsh-syntax-highlighting"]="https://github.com/zsh-users/zsh-syntax-highlighting"
)

if [[ ! -d "PLUGIN_DIR" ]]; then
  log_info "Creating plugin directory: $PLUGIN_DIR"
  mkdir -p "$PLUGIN_DIR"
  log_ok "âœ…  $PLUGIN_DIR created"
fi

log_info "ğŸ”Œ Managing Zsh plugins..."

for plugin repo in ${(kv)ZSH_PLUGINS}; do
  plugin_path="$PLUGIN_DIR/$plugin"

  if [[ ! -d "$plugin_path/.git" ]]; then
    log_info "Installing $plugin"
    git clone --depth=1 "$repo" "$plugin_path" \
      && log_ok "âœ… $plugin installed" \
      || log_warn "Failed to install $plugin"
  else
    log_info "Updating $plugin"
    git -C "$plugin_path" pull --ff-only --quiet \
      && log_ok "$plugin updated" \
      || log_warn "Failed to update $plugin"
  fi
done

# A. Install Core Packages (Always)
BREWFILE_CORE="$HOME/.Brewfile"
if [ -f "$BREWFILE_CORE" ]; then
    log_info "ğŸ“¦ Installing Core packages from .Brewfile..."
    brew bundle --file="$BREWFILE_CORE"
    log_ok "$BREWFILE_CORE installed"
fi

# B. Install Local/Optional Packages (Interactive)
BREWFILE_LOCAL="$HOME/.Brewfile_local"
if [ -f "$BREWFILE_LOCAL" ]; then
    echo -n "â“ Found .Brewfile_local. Do you want to install its packages? (y/N): " > /dev/tty
    read -r response < /dev/tty
    if [[ "$response" =~ ^([yY][eE][sS]|[yY])$ ]]; then
        log_info "ğŸš€ Installing Local packages from $BREWFILE_LOCAL..."
        brew bundle --file="$BREWFILE_LOCAL"
        log_ok "$BREWFILE_LOCAL installed"
    else
        log_warn "â­ï¸  Skipping Local packages."
    fi
fi
{{ end -}}

# --- 3. Linux Setup ---
{{ if eq .chezmoi.os "linux" -}}
# (Your Linux logic remains here)
{{ end -}}

log_ok "âœ¨ Configuration complete!"

