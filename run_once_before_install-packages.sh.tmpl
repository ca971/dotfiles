#!/usr/bin/env zsh

# Fail early if not running under Zsh
[[ -z "$ZSH_VERSION" ]] && return

# Utilities
log_info() {
  print -P "%F{cyan}[chez-moi]%f $1"
}

log_ok() {
  print -P "%F{green}[chez-moi]%f $1"
}

log_warn() {
  print -P "%F{yellow}[chez-moi]%f $1"
}

# --- 1. OS Detection ---
OS_TYPE="{{ .chezmoi.os }}"
echo "ğŸ” Detected OS: $OS_TYPE"

# --- 2. macOS Setup ---
{{ if eq .chezmoi.os "darwin" -}}
log_info "ğŸ Starting macOS Setup..."

# Xcode Command Line Tools
if ! xcode-select -p &> /dev/null; then
    log_info "ğŸ› ï¸  Xcode Command Line Tools not found. Installing..."
    xcode-select --install
    until xcode-select -p &> /dev/null; do sleep 5; done
    log_ok "âœ…  Xcode Command Line Tools Installed"
fi

# Homebrew
if ! command -v brew &> /dev/null; then
    log_info "ğŸº Installing Homebrew..."
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    [ -d "/opt/homebrew/bin" ] && eval "$(/opt/homebrew/bin/brew shellenv)"
    log_ok "âœ…  Homebrew Installed"
fi

# --- C. Zsh Plugins & Completions (Managed by Chezmoi) ---

PLUGIN_DIR="$HOME/.local/share/zsh-plugins"
COMPLETION_DIR="$PLUGIN_DIR/completions"

# Create directories if they don't exist
[[ ! -d "$PLUGIN_DIR" ]] && mkdir -p "$PLUGIN_DIR"
[[ ! -d "$COMPLETION_DIR" ]] && mkdir -p "$COMPLETION_DIR"

# 1. Essential Zsh Plugins
# Added: zsh-completions (extra completion definitions)
declare -A ZSH_PLUGINS=(
    ["fzf-tab"]="https://github.com/Aloxaf/fzf-tab"
    ["zsh-autosuggestions"]="https://github.com/zsh-users/zsh-autosuggestions"
    ["zsh-syntax-highlighting"]="https://github.com/zsh-users/zsh-syntax-highlighting"
    ["zsh-completions"]="https://github.com/zsh-users/zsh-completions"
)

log_info "ğŸ”Œ Managing Zsh plugins..."
for plugin repo in ${(kv)ZSH_PLUGINS}; do
  plugin_path="$PLUGIN_DIR/$plugin"
  if [[ ! -d "$plugin_path/.git" ]]; then
    log_info "Installing $plugin"
    git clone --depth=1 "$repo" "$plugin_path" && log_ok "âœ… $plugin installed"
  else
    log_info "Updating $plugin"
    git -C "$plugin_path" pull --ff-only --quiet && log_ok "âœ… $plugin updated"
  fi
done

# 2. Generate/Update Shell Completions
log_info "âŒ¨ï¸  Generating shell completions..."

# chezmoi
if command -v chezmoi &> /dev/null; then
    chezmoi completion zsh > "$COMPLETION_DIR/_chezmoi"
    log_ok "âœ… chezmoi completion updated"
fi

# docker (Fetch official completions)
if command -v docker &> /dev/null; then
    # Docker completions are often provided by the binary, but we ensure they are in our fpath
    curl -sSL https://raw.githubusercontent.com/docker/cli/master/contrib/completion/zsh/_docker > "$COMPLETION_DIR/_docker"
    log_ok "âœ… docker completion updated"
fi

# mise (Modern tool manager)
if command -v mise &> /dev/null; then
    mise completion zsh > "$COMPLETION_DIR/_mise"
    log_ok "âœ… mise completion updated"
fi

# brew (Homebrew completions)
if command -v brew &> /dev/null; then
    # Brew handles its own completions, but we can link them for consistency
    # or just rely on brew's internal paths. Adding a placeholder or link here:
    log_ok "â„¹ï¸  brew completions are managed via site-functions"
fi

# Add other tools here if needed (e.g., mise, brew)
# if command -v mise &> /dev/null; then mise completion zsh > "$COMPLETION_DIR/_mise"; fi

# --- D. Homebrew Packages ---

# A. Install Core Packages (Always)
BREWFILE_CORE="$HOME/.Brewfile"
if [ -f "$BREWFILE_CORE" ]; then
    log_info "ğŸ“¦ Installing Core packages from .Brewfile..."
    brew bundle --file="$BREWFILE_CORE"
    log_ok "âœ… $BREWFILE_CORE installed"
fi

# B. Install Local/Optional Packages (Interactive)
BREWFILE_LOCAL="$HOME/.Brewfile_local"
if [ -f "$BREWFILE_LOCAL" ]; then
    echo -n "â“ Found .Brewfile_local. Do you want to install its packages? (y/N): " > /dev/tty
    read -r response < /dev/tty
    if [[ "$response" =~ ^([yY][eE][sS]|[yY])$ ]]; then
        log_info "ğŸš€ Installing Local packages from $BREWFILE_LOCAL..."
        brew bundle --file="$BREWFILE_LOCAL"
        log_ok "âœ… $BREWFILE_LOCAL installed"
    else
        log_warn "â­ï¸  Skipping Local packages."
    fi
fi
{{ end -}}

# --- 3. Linux Setup ---
{{ if eq .chezmoi.os "linux" -}}
# (Linux logic)
{{ end -}}

log_ok "âœ¨ Configuration complete!"

