#!/usr/bin/env zsh

# --- 0. INITIALIZATION & UTILITIES ---
# Ensure the script stops on errors and handles Zsh specifics
set -e
[[ -z "$ZSH_VERSION" ]] && return

# Styled logging functions for better visibility
log_info() { print -P "%F{cyan}[INFO]%f $1"; }
log_ok()   { print -P "%F{green}[OK]%f   $1"; }
log_warn() { print -P "%F{yellow}[WARN]%f $1"; }

# --- 1. SYSTEM DETECTION ---
# Identify the operating system and architecture
OS_TYPE="{{ .chezmoi.os }}"
ARCH_TYPE="{{ .chezmoi.arch }}"
log_info "ðŸ” Environment: $OS_TYPE ($ARCH_TYPE)"

# --- 2. MACOS BOOTSTRAP (DARWIN) ---
{{ if eq .chezmoi.os "darwin" -}}

# Install Xcode Command Line Tools if missing
if ! xcode-select -p &> /dev/null; then
    log_info "ðŸ› ï¸  Installing Xcode Command Line Tools..."
    xcode-select --install
    until xcode-select -p &> /dev/null; do sleep 5; done
    log_ok "Xcode CLI Tools ready"
fi

# Install Homebrew if not found
if ! command -v brew &> /dev/null; then
    log_info "ðŸº Installing Homebrew..."
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    [ -d "/opt/homebrew/bin" ] && eval "$(/opt/homebrew/bin/brew shellenv)"
    log_ok "Homebrew installed"
fi

# --- 3. PACKAGE MANAGEMENT (BREW BUNDLE) ---

# Process global Brewfile (includes apps, cli tools, and fonts)
BREW_CORE="$HOME/.Brewfile"
if [[ -f "$BREW_CORE" ]]; then
    log_info "ðŸ“¦ Processing global Brewfile..."
    brew bundle --file="$BREW_CORE"
    log_ok "Global packages installed"
fi

# Process local/optional Brewfile interactively
BREW_LOCAL="$HOME/.Brewfile_local"
if [[ -f "$BREW_LOCAL" ]]; then
    echo -n "â“ Install optional local packages? (y/N): " > /dev/tty
    read -r response < /dev/tty
    if [[ "$response" =~ ^([yY][eE][sS]|[yY])$ ]]; then
        log_info "ðŸš€ Processing local Brewfile..."
        brew bundle --file="$BREW_LOCAL"
        log_ok "Local packages installed"
    fi
fi

# --- 4. LANGUAGE RUNTIMES & TOOLS (MISE) ---

# Manage language runtimes (Neovim stable/nightly)
if command -v mise &> /dev/null; then
    log_info "ðŸª„ Setting up Neovim versions with mise..."
    
    # Install and set Neovim versions
    mise install neovim@stable
    mise install neovim@nightly
    
    # Default to stable for global usage
    mise use --global neovim@stable
    log_ok "Neovim stable/nightly ready (Default: stable)"
else
    log_warn "Mise not found. Skipping runtime management."
fi

# --- 5. SHELL ENVIRONMENT (ZSH PLUGINS) ---

PLUGIN_DIR="$HOME/.local/share/zsh-plugins"
COMPLETION_DIR="$PLUGIN_DIR/completions"

# Ensure necessary directories exist
mkdir -p "$COMPLETION_DIR"

declare -A PLUGINS=(
    ["fzf-tab"]="https://github.com/Aloxaf/fzf-tab"
    ["zsh-autosuggestions"]="https://github.com/zsh-users/zsh-autosuggestions"
    ["zsh-syntax-highlighting"]="https://github.com/zsh-users/zsh-syntax-highlighting"
    ["zsh-completions"]="https://github.com/zsh-users/zsh-completions"
)

log_info "ðŸ”Œ Managing Zsh plugins..."
for name repo in ${(kv)PLUGINS}; do
    target="$PLUGIN_DIR/$name"
    if [[ ! -d "$target" ]]; then
        log_info "Cloning $name..."
        git clone --depth=1 "$repo" "$target"
    else
        log_info "Updating $name..."
        git -C "$target" pull --ff-only --quiet
    fi
done

# --- 6. COMPLETION GENERATION ---

log_info "âŒ¨ï¸  Refreshing completions..."

# Update completions for essential tools
[[ -x "$(command -v chezmoi)" ]] && chezmoi completion zsh > "$COMPLETION_DIR/_chezmoi"
[[ -x "$(command -v mise)" ]]    && mise completion zsh    > "$COMPLETION_DIR/_mise"
if [[ -x "$(command -v docker)" ]]; then
    curl -sSL https://raw.githubusercontent.com/docker/cli/master/contrib/completion/zsh/_docker > "$COMPLETION_DIR/_docker"
fi

{{ end -}}

# --- 7. LINUX SPECIFIC SETUP ---
{{ if eq .chezmoi.os "linux" -}}
# Add Linux-specific bootstrap logic here
{{ end -}}

log_ok "âœ¨ System bootstrap completed successfully!"

