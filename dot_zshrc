# Enable Powerlevel10k instant prompt. Should stay close to the top of ~/.zshrc.
if [[ -r "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh" ]]; then
  source "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh"
fi

# Path to your Oh My Zsh installation.
export ZSH="$HOME/.oh-my-zsh"

# Set name of the theme to load 
ZSH_THEME="powerlevel10k/powerlevel10k"

source $ZSH/oh-my-zsh.sh

# User configuration

# export MANPATH="/usr/local/man:$MANPATH"

# You may need to manually set your language environment
# export LANG=en_US.UTF-8

# Preferred editor for local and remote sessions
# if [[ -n $SSH_CONNECTION ]]; then
#   export EDITOR='vim'
# else
#   export EDITOR='nvim'
# fi

# Compilation flags
# export ARCHFLAGS="-arch $(uname -m)"

# D√©finition de l'√©diteur par d√©faut
if (( $+commands[nvim] )); then
    export EDITOR='nvim'
else
    export EDITOR='vim'
fi

# EDITOR alias
alias v=$EDITOR

alias c='clear'

# --- LSD / EZA aliases (ls replacement) ---
if (( $+commands[eza] )); then
    alias ls='eza --icons --group-directories-first'
    alias ll='eza -lh --icons --git --group-directories-first'
    alias la='eza -a --icons --group-directories-first'
    alias lt='eza --tree --level=2 --icons'
elif (( $+commands[lsd] )); then
    alias ls='lsd'
    alias ll='lsd -l'
    alias la='lsd -a'
    alias lt='lsd --tree'
fi

# --- Navigation Rapide ---
alias ..='cd ..'
alias ...='cd ../..'
alias ....='cd ../../..'
alias -- -='cd -' # Revient au dossier pr√©c√©dent
alias dot='chezmoi cd' # Va direct dans le dossier source des dotfiles

# --- Network ---
alias ip="curl ifconfig.me" # R√©cup√®re ton IP publique rapidement
alias ports='netstat -tulanp' # Liste les ports ouverts (utile en cas de conflit)

# --- Utilitaires ---
alias reload='source ~/.zprofile' # Recharge la config apr√®s modif
alias path='echo $PATH | tr ":" "\n"' # Affiche le PATH de fa√ßon lisible
alias mkdir='mkdir -p' # Cr√©e les dossiers parents si n√©cessaire

# --- Docker ---
alias d='docker'
alias dc='docker-compose'
alias dps='docker ps --format "table {{.ID}}\t{{.Names}}\t{{.Status}}\t{{.Ports}}"' # Un PS Docker propre
alias dimg='docker images'
alias drmi='docker rmi $(docker images -q -f "dangling=true")' # Nettoie les images inutilis√©es
alias dstop='docker stop $(docker ps -a -q)' # Arr√™te tous les containers

# --- Kubernetes (si install√©) ---
if (( $+commands[kubectl] )); then
    alias k='kubectl'
    alias kgp='kubectl get pods'
    alias kgs='kubectl get svc'
    alias kga='kubectl get all'
fi

# --- System Monitoring ---
if (( $+commands[btop] )); then
    alias top='btop'
elif (( $+commands[htop] )); then
    alias top='htop'
fi

if (( $+commands[duf] )); then
  alias df='duf'
elif (( $+commands[dfc] )); then
  alias df='dfc'
fi

if (( $+commands[bat] )); then
  alias cat='bat'
fi

alias du='du -sh' # Taille d'un dossier en format humain
alias free='free -m -h' # M√©moire vive lisible

# --- S√©curit√© & Droits ---
if [[ "$OSTYPE" == "linux-gnu"* ]]; then
    alias chmod='chmod --preserve-root'
    alias chown='chown --preserve-root'
fi
alias sshy='ssh -o StrictHostKeyChecking=no' # Pour les tests rapides (√† utiliser avec prudence)


# Extraire n'importe quel type d'archive d'une seule commande
extract () {
   if [ -f $1 ] ; then
       case $1 in
           *.tar.bz2)   tar xvjf $1    ;;
           *.tar.gz)    tar xvzf $1    ;;
           *.bz2)       bunzip2 $1     ;;
           *.rar)       unrar x $1      ;;
           *.gz)        gunzip $1      ;;
           *.tar)       tar xvf $1     ;;
           *.tbz2)      tar xvjf $1    ;;
           *.tgz)       tar xvzf $1    ;;
           *.zip)       unzip $1       ;;
           *.Z)         uncompress $1  ;;
           *.7z)        7za x $1        ;;
           *)           echo "don't know how to extract '$1'..." ;;
       esac
   else
       echo "'$1' is not a valid file!"
   fi
}

# Cr√©er un dossier et entrer dedans imm√©diatement
mkcd() {
  mkdir -p "$1" && cd "$1"
}

# FZF
# Preview des fichiers avec 'bat' lors d'une recherche (CTRL+T)
export FZF_CTRL_T_OPTS="
  --preview 'bat --style=numbers --color=always --line-range :500 {}'
  --bind 'ctrl-/:change-preview-window(down|hidden|)'"


  # --- FZF Configuration ---
if (( $+commands[fzf] )); then
  # Initialisation native
  source <(fzf --zsh)

  # Utiliser 'fd' au lieu de 'find' pour la rapidit√© et ignorer le .git
  #export FZF_DEFAULT_COMMAND='fd --type f --strip-cwd-prefix --hidden --follow --exclude .git'
  #export FZF_CTRL_T_COMMAND="$FZF_DEFAULT_COMMAND"

  # Options visuelles (Th√®me √©pur√© et Preview)
  export FZF_DEFAULT_OPTS="
    --height 45% 
    --layout=reverse 
    --border 
    --inline-info 
    --color='header:italic:underline'
    --preview-window='right:60%:wrap'
  "

  # Preview du contenu des fichiers avec 'bat' sur CTRL+T
  export FZF_CTRL_T_OPTS="--preview 'bat --style=numbers --color=always --line-range :500 {}'"
  
  # Recherche dans l'historique avec CTRL+R (plus lisible)
  export FZF_CTRL_R_OPTS="--preview 'echo {}' --preview-window down:3:hidden:wrap --bind '?:toggle-preview'"
fi

# fz: Chercher un fichier et l'ouvrir avec ton √©diteur par d√©faut (nvim ou nano)
fz() {
  local file
  file=$(fd --type f --hidden --exclude .git | fzf --preview 'bat --style=numbers --color=always --line-range :500 {}')
  if [[ -n "$file" ]]; then
    ${EDITOR:-nvim} "$file"
  fi
}

# fcd: Chercher un dossier et se d√©placer dedans
fcd() {
  local dir
  dir=$(fd --type d --hidden --exclude .git | fzf --preview 'lsd --tree --depth 2 {}')
  if [[ -n "$dir" ]]; then
    cd "$dir"
  fi
}

# Git
# --- Git Shortcuts (Ultra-rapides) ---
alias g='git'
alias gs='git status'
alias ga='git add'
alias gc='git commit -m'
alias gp='git push'
alias gl='git log --oneline --graph --decorate'
alias gdiff='git diff'

# --- Git Avanc√© ---
alias gcn='git commit --no-edit --amend' # Rajoute les modifs au dernier commit sans changer le message
alias gcan='git add -A && git commit --no-edit --amend' # Le fameux "oups j'ai oubli√© un fichier"
alias gb='git branch'
alias gco='git checkout'
alias gcb='git checkout -b' # Cr√©er et switcher sur une branche
alias gd='git diff --color-words' # Diff plus lisible mot par mot

# Recherche interactive dans les alias Git
gal() {
  git config --get-regexp '^alias\.' | \
  sed 's/^alias\.//' | \
  fzf --header "Git Aliases" \
      --height 40% \
      --layout=reverse | \
  cut -d' ' -f1
}

# ghp: List your GitHub repos and choose to Clone or Browse
ghp() {
  local repo
  # On utilise 'fields' pour avoir un format texte brut ultra-propre s√©par√© par des tabulations
  repo=$(gh repo list --limit 100 --json fullName,description --jq '.[] | [.fullName, .description] | @tsv' | \
    fzf --delimiter $'\t' \
        --header "[ENTER] Select | [ESC] Quit" \
        --preview "gh repo view {1}" \
        --height 70% \
        --layout=reverse | cut -f1)

  if [[ -n "$repo" ]]; then
    echo -e "\nüì¶ Repository: \033[1;36m$repo\033[0m"
    # Utilisation d'un menu simple sans 'read -k' qui peut bugger sur certains terminaux
    echo "1) Clone | 2) Browse | 3) Cancel"
    printf "Choice: "
    read choice
    
    case $choice in
      1) git clone "https://github.com/$repo.git" ;;
      2) gh browse "$repo" ;;
      *) echo "Aborted." ;;
    esac
  fi
}

# A lot of repos into one folder (ex : ~/Projects/)
# Alias to find forgotten commits into a lot of repos in a folder
alias gstatus='find . -maxdepth 2 -name ".git" -type d | rev | cut -d/ -f2- | rev | xargs -I {} sh -c "echo -e \"\n\033[1;32mRepo: {}\033[0m\"; git -C {} status -s"'

# edot: √âdite un fichier g√©r√© par chezmoi et applique les changements √† la fermeture
# Usage: edot (√©dite .zshrc par d√©faut) ou edot ~/.gitconfig
edot() {
  local file=${1:-~/.zshrc}
  chezmoi edit --apply "$file"
}

# Oh-My-Zsh plugins
plugins=(
  git
  zsh-autosuggestions
  zsh-syntax-highlighting
  zoxide
  fzf
  docker
)

# Load local secrets
[[ -f ~/.zsh_secrets ]] && source ~/.zsh_secrets

# Charger les secrets locaux s'ils existent (non suivis par Git)
[[ -f ~/.zshrc_local ]] && source ~/.zshrc_local

# To customize prompt, run `p10k configure` or edit ~/.p10k.zsh.
[[ ! -f ~/.p10k.zsh ]] || source ~/.p10k.zsh

