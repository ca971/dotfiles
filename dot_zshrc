# Enable Powerlevel10k instant prompt. Should stay close to the top of ~/.zshrc.
if [[ -r "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh" ]]; then
  source "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh"
fi

# Path to your Oh My Zsh installation.
export ZSH="$HOME/.oh-my-zsh"

# Set name of the theme to load 
ZSH_THEME="powerlevel10k/powerlevel10k"

source $ZSH/oh-my-zsh.sh

# User configuration

# export MANPATH="/usr/local/man:$MANPATH"

# You may need to manually set your language environment
# export LANG=en_US.UTF-8

# Preferred editor for local and remote sessions
# if [[ -n $SSH_CONNECTION ]]; then
#   export EDITOR='vim'
# else
#   export EDITOR='nvim'
# fi

# Compilation flags
# export ARCHFLAGS="-arch $(uname -m)"

# Définition de l'éditeur par défaut
if (( $+commands[nvim] )); then
    export EDITOR='nvim'
else
    export EDITOR='vim'
fi

# EDITOR alias
alias v=$EDITOR

alias c='clear'

# --- LSD / EZA aliases (ls replacement) ---
if (( $+commands[eza] )); then
    alias ls='eza --icons --group-directories-first'
    alias ll='eza -lh --icons --git --group-directories-first'
    alias la='eza -a --icons --group-directories-first'
    alias lt='eza --tree --level=2 --icons'
elif (( $+commands[lsd] )); then
    alias ls='lsd'
    alias ll='lsd -l'
    alias la='lsd -a'
    alias lt='lsd --tree'
fi

# --- Navigation Rapide ---
alias ..='cd ..'
alias ...='cd ../..'
alias ....='cd ../../..'
alias -- -='cd -' # Revient au dossier précédent
alias dot='chezmoi cd' # Va direct dans le dossier source des dotfiles

# --- Git Shortcuts (Ultra-rapides) ---
alias g='git'
alias gs='git status'
alias ga='git add'
alias gc='git commit -m'
alias gp='git push'
alias gl='git log --oneline --graph --decorate'
alias gdiff='git diff'

# --- Git Avancé ---
alias gcn='git commit --no-edit --amend' # Rajoute les modifs au dernier commit sans changer le message
alias gcan='git add -A && git commit --no-edit --amend' # Le fameux "oups j'ai oublié un fichier"
alias gb='git branch'
alias gco='git checkout'
alias gcb='git checkout -b' # Créer et switcher sur une branche
alias gd='git diff --color-words' # Diff plus lisible mot par mot

# --- Network ---
alias ip="curl ifconfig.me" # Récupère ton IP publique rapidement
alias ports='netstat -tulanp' # Liste les ports ouverts (utile en cas de conflit)

# --- Utilitaires ---
alias reload='source ~/.zprofile' # Recharge la config après modif
alias path='echo $PATH | tr ":" "\n"' # Affiche le PATH de façon lisible
alias mkdir='mkdir -p' # Crée les dossiers parents si nécessaire

# --- Docker ---
alias d='docker'
alias dc='docker-compose'
alias dps='docker ps --format "table {{.ID}}\t{{.Names}}\t{{.Status}}\t{{.Ports}}"' # Un PS Docker propre
alias dimg='docker images'
alias drmi='docker rmi $(docker images -q -f "dangling=true")' # Nettoie les images inutilisées
alias dstop='docker stop $(docker ps -a -q)' # Arrête tous les containers

# --- Kubernetes (si installé) ---
if (( $+commands[kubectl] )); then
    alias k='kubectl'
    alias kgp='kubectl get pods'
    alias kgs='kubectl get svc'
    alias kga='kubectl get all'
fi

# --- System Monitoring ---
if (( $+commands[btop] )); then
    alias top='btop'
elif (( $+commands[htop] )); then
    alias top='htop'
fi

if (( $+commands[duf] )); then
  alias df='duf'
elif (( $+commands[dfc] )); then
  alias df='dfc'
fi

if (( $+commands[bat] )); then
  alias cat='bat'
fi

alias du='du -sh' # Taille d'un dossier en format humain
alias free='free -m -h' # Mémoire vive lisible

# --- Sécurité & Droits ---
if [[ "$OSTYPE" == "linux-gnu"* ]]; then
    alias chmod='chmod --preserve-root'
    alias chown='chown --preserve-root'
fi
alias sshy='ssh -o StrictHostKeyChecking=no' # Pour les tests rapides (à utiliser avec prudence)


# Extraire n'importe quel type d'archive d'une seule commande
extract () {
   if [ -f $1 ] ; then
       case $1 in
           *.tar.bz2)   tar xvjf $1    ;;
           *.tar.gz)    tar xvzf $1    ;;
           *.bz2)       bunzip2 $1     ;;
           *.rar)       unrar x $1      ;;
           *.gz)        gunzip $1      ;;
           *.tar)       tar xvf $1     ;;
           *.tbz2)      tar xvjf $1    ;;
           *.tgz)       tar xvzf $1    ;;
           *.zip)       unzip $1       ;;
           *.Z)         uncompress $1  ;;
           *.7z)        7za x $1        ;;
           *)           echo "don't know how to extract '$1'..." ;;
       esac
   else
       echo "'$1' is not a valid file!"
   fi
}

# Créer un dossier et entrer dedans immédiatement
mkcd() {
  mkdir -p "$1" && cd "$1"
}

# FZF
# Preview des fichiers avec 'bat' lors d'une recherche (CTRL+T)
export FZF_CTRL_T_OPTS="
  --preview 'bat --style=numbers --color=always --line-range :500 {}'
  --bind 'ctrl-/:change-preview-window(down|hidden|)'"


  # --- FZF Configuration ---
if (( $+commands[fzf] )); then
  # Initialisation native
  source <(fzf --zsh)

  # Utiliser 'fd' au lieu de 'find' pour la rapidité et ignorer le .git
  #export FZF_DEFAULT_COMMAND='fd --type f --strip-cwd-prefix --hidden --follow --exclude .git'
  #export FZF_CTRL_T_COMMAND="$FZF_DEFAULT_COMMAND"

  # Options visuelles (Thème épuré et Preview)
  export FZF_DEFAULT_OPTS="
    --height 45% 
    --layout=reverse 
    --border 
    --inline-info 
    --color='header:italic:underline'
    --preview-window='right:60%:wrap'
  "

  # Preview du contenu des fichiers avec 'bat' sur CTRL+T
  export FZF_CTRL_T_OPTS="--preview 'bat --style=numbers --color=always --line-range :500 {}'"
  
  # Recherche dans l'historique avec CTRL+R (plus lisible)
  export FZF_CTRL_R_OPTS="--preview 'echo {}' --preview-window down:3:hidden:wrap --bind '?:toggle-preview'"
fi


# Oh-My-Zsh plugins
plugins=(
  git
  zsh-autosuggestions
  zsh-syntax-highlighting
  zoxide
  fzf
  docker
)

# To customize prompt, run `p10k configure` or edit ~/.p10k.zsh.
[[ ! -f ~/.p10k.zsh ]] || source ~/.p10k.zsh

# Charger les secrets locaux s'ils existent (non suivis par Git)
[[ -f ~/.zshrc_local ]] && source ~/.zshrc_local
