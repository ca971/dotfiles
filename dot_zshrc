# ------------------------------------------------------------------------------
# .zshrc - Interactive Shell Configuration
# ------------------------------------------------------------------------------

# --- POWERLEVEL10K INSTANT PROMPT ---

# Enable Instant Prompt to make the shell startup feel faster.
# This should stay at the very top of ~/.zshrc.
if [[ -r "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh" ]]; then
  source "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh"
fi

# Path to Oh My Zsh installation
export ZSH="$HOME/.oh-my-zsh"
ZSH_THEME="powerlevel10k/powerlevel10k"

# # --- Advanced Completion System Configuration ---
#
# # Load the completion module
# autoload -Uz compinit && compinit
#
# # 1. Visual selection menu (allows arrow key navigation)
# zstyle ':completion:*' menu select
#
# # 2. Case-insensitive and partial matching
# # Matches 'doc' to 'Documents', 'downloads' to 'Downloads', etc.
# zstyle ':completion:*' matcher-list 'm:{a-zA-Z}={A-Za-z}' 'r:|[._-]=* r:|=*' 'l:|=* r:|=*'
#
# # 3. Use terminal colors (LS_COLORS) in the completion menu
# zstyle ':completion:*:default' list-colors ${(s.:.)LS_COLORS}
#
# # 4. Group results by category (Files, Directories, Commands)
# zstyle ':completion:*' group-name ''
# zstyle ':completion:*:descriptions' format $'\e[01;33m-- %d --\e[00m'
# zstyle ':completion:*:messages' format $'\e[01;35m-- %d --\e[00m'
#
# # 5. Smart 'cd' behavior: ignore parent directory (..) when completing
# zstyle ':completion:*:cd:*' ignore-parents parent pwd
#
# # 6. Process completion styling (better colors for the 'kill' command)
# zstyle ':completion:*:*:kill:*:processes' list-colors '=(#b) #([0-9]#) ([0-9a-z-]#)*=01;34=01;31'

# --- Plugin Specific Tweaks ---

# Make zsh-autosuggestions color more subtle (dark gray)
export ZSH_AUTOSUGGEST_HIGHLIGHT_STYLE='fg=240'

# --- Plugin Management ---
# Essential plugins for productivity
plugins=(
    git 
    zoxide 
    fzf 
    docker 
    kubectl
)

# Load Oh My Zsh
source $ZSH/oh-my-zsh.sh

# --- 2. INTERACTIVE TOOLS ---

# Fzf: Fuzzy search
(( $+commands[fzf] )) && source <(fzf --zsh) 2>/dev/null

# Mise: Polyglot tool manager
(( $+commands[mise] )) && eval "$(mise activate zsh)" 2>/dev/null

# Zoxide: Smarter 'cd' command
(( $+commands[zoxide] )) && eval "$(zoxide init zsh)" 2>/dev/null

# TheFuck: Auto-correction for console commands
(( $+commands[thefuck] )) && eval "$(thefuck --alias)" 2>/dev/null

# # Load the completion module
autoload -Uz compinit && compinit

# Load plugins
#
# --- Late Loading Plugins (Optimizes speed) ---
PLUGIN_DIR="$HOME/.local/share/zsh-plugins/"

# Associative array: plugin_name -> git_repository
declare -a ZSH_PLUGINS=(
  "fzf-tab"
  "zsh-autosuggestions"
  "zsh-syntax-highlighting"
)

# NOTE:
# zsh-syntax-highlighting must be sourced LAST
# fzf-tab must be sourced BEFORE completion init
#
for plugin in ${ZSH_PLUGINS[@]}; do
  plugin_path="$PLUGIN_DIR/$plugin"
#
  # Try common entrypoints
  if [[ -f "$plugin_path/$plugin.zsh" ]]; then
    source "$plugin_path/$plugin.zsh"
  elif [[ -f "$plugin_path/$plugin.plugin.zsh" ]]; then
    source "$plugin_path/$plugin.plugin.zsh"
  elif [[ -f "$plugin_path/zsh-$plugin.zsh" ]]; then
    source "$plugin_path/zsh-$plugin.zsh"
  fi
done

# Explicit ordering for sensitive plugins
if [[ -f "$PLUGIN_DIR/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh" ]]; then
  source "$PLUGIN_DIR/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh"
fi

# --- 3. ZSH CORE BEHAVIOR ---

setopt AUTO_CD              # Enter directory without typing 'cd'
setopt CORRECT              # Spelling correction for commands
setopt EXTENDED_GLOB        # Advanced globbing (#, ~, ^)
setopt SHARE_HISTORY        # Share history across sessions
setopt AUTO_PUSHD           # Push visited dirs to stack
setopt PUSHD_IGNORE_DUPS    # Avoid duplicates in stack
unsetopt BEEP               # Silence terminal bells

# --- 5. PREFERRED TOOLS (FALLBACK LOGIC) ---

# Editor: Use Neovim if available, fallback to Vim
export EDITOR=${commands[nvim]:-vim}
export VISUAL=$EDITOR

# Pager: Use Most for colored man pages, fallback to Less
export PAGER=${commands[most]:-less}
export MANPAGER=$PAGER

# --- 6. FZF CONFIGURATION (FUZZY FINDER) ---

if (( $+commands[fzf] )); then

    # General UI/UX
    export FZF_DEFAULT_OPTS="
        --height 45% 
        --layout=reverse 
        --border 
        --inline-info 
        --color='header:italic:underline'
        --preview-window='right:60%:wrap'
    "

    # Search Logic: Use 'fd' for speed and to respect .gitignore
    if (( $+commands[fd] )); then
        export FZF_DEFAULT_COMMAND='fd --type f --strip-cwd-prefix --hidden --follow --exclude .git'
        export FZF_CTRL_T_COMMAND="$FZF_DEFAULT_COMMAND"
    fi

    # File Preview Logic (CTRL+T) using 'bat'
    if (( $+commands[bat] )); then
        export FZF_CTRL_T_OPTS="
            --preview 'bat --style=numbers --color=always --line-range :500 {}'
            --bind 'ctrl-/:change-preview-window(down|hidden|)'"
    fi

    # History Search Logic (CTRL+R)
    export FZF_CTRL_R_OPTS="--preview 'echo {}' --preview-window down:3:hidden:wrap --bind '?:toggle-preview'"
fi

# --- fzf-tab Configuration ---
# Replace the standard completion menu with fzf
# Use the correct Homebrew path for fzf-tab on Apple Silicon
if [[ -f "/opt/homebrew/opt/fzf-tab/share/fzf-tab/fzf-tab.zsh" ]]; then
    source "/opt/homebrew/opt/fzf-tab/share/fzf-tab/fzf-tab.zsh"
fi

# Disable sort when completing `git checkout`
zstyle ':completion:*:git-checkout:*' sort false

# Set descriptions format to enable group support
zstyle ':completion:*:descriptions' format '[%d]'

# Preview directory content with eza when completing cd
zstyle ':fzf-tab:complete:cd:*' fzf-preview 'eza -1 --color=always $realpath'

# Preview file content with bat when completing cat
zstyle ':fzf-tab:complete:cat:*' fzf-preview 'bat --color=always --style=numbers $realpath'

# --- 7. SYSTEM ALIASES ---

# General Shortcuts
alias v="$EDITOR"
alias c='clear'
alias q='exit'
alias dot='chezmoi cd'
alias reload='source ~/.zshrc'
alias path='echo $PATH | tr ":" "\n"'
alias mkdir='mkdir -p'

# Navigation
alias ..='cd ..'
alias ...='cd ../..'
alias ....='cd ../../..'
alias -- -='cd -'
alias d='dirs -v | head -10'
alias 1='cd -1'
alias 2='cd -2'

# Modern Replacements
if (( $+commands[eza] )); then
    alias ls='eza --icons --group-directories-first'
    alias ll='ls -lh --git'
    alias la='ls -a'
    alias lt='eza --tree --level=2 --icons'
elif (( $+commands[lsd] )); then
    alias ls='lsd'
    alias ll='ls -l'
    alias la='ls -a'
    alias lt='ls --tree'
fi

(( $+commands[bat] )) && alias cat='bat' 2>/dev/null
(( $+commands[btop] )) && alias top='btop' 2>/dev/null
(( $+commands[duf] )) && alias df='duf' 2>/dev/null

# Chezmoi
# Update the main Brewfile (tracked by chezmoi)
alias bdump="brew bundle dump --force --global"

# Update the local Brewfile (not tracked or ignored)
alias bdump-local="brew bundle dump --force --file=~/.Brewfile_local"

# --- 8. ZSH GLOB QUALIFIER ALIASES ---

alias l.='ls *(.)'           # Files only
alias l/='ls *(/)'           # Directories only
alias lnb='ls -ld *(@-)'     # Broken symlinks
alias ln='ls -ld *(@)'       # Symlinks only
alias l1='ls *(m-1)'         # Modified last 24h
alias lL='ls *(L+10M)'       # Larger than 10MB
alias lK='ls *(LK+50)'       # Larger than 50KB

# --- 9. GLOBAL ALIASES (Work anywhere in the command line) ---

alias -g G='| grep -i'
alias -g L='| less'
alias -g M='| most'
alias -g H='| head'
alias -g T='| tail'
alias -g NE='2> /dev/null'

# --- 10. DEVELOPMENT TOOLS ---

# Docker
alias dk='docker'
alias dc='docker-compose'
alias dps='docker ps --format "table {{.ID}}\t{{.Names}}\t{{.Status}}\t{{.Ports}}"'
alias drmi='docker rmi $(docker images -q -f "dangling=true")'

# Kubernetes
if (( $+commands[kubectl] )); then
  alias k='kubectl'
  alias kgp='kubectl get pods'
  alias kgs='kubectl get svc'
fi

# Git
alias g='git'

# --- Git Performance Optimizations ---
# Disable git status on very large repositories to prevent lag
# You can still run 'git status' manually.
zstyle ':vcs_info:*' disable-patterns "$HOME/Documents/VeryLargeProject*"

# Enable Powerlevel10k's internal git status caching
typeset -g POWERLEVEL9K_VCS_MAX_INDEX_SIZE_DIRTY=10000

# --- 11. USER FUNCTIONS ---

# lre: Recursive search by extension (Usage: lre pdf)
lre() {
    if [[ -z "$1" ]]; then
        fd --type f | fzf --preview 'bat --color=always --line-range :500 {}'
    else
        ls -ld **/*.$1(.)
    fi
}

# fz: Interactive file finder & opener
fz() {
    local file=$(fd --type f --hidden --exclude .git | fzf)
    [[ -n "$file" ]] && ${EDITOR:-nvim} "$file"
}

# fcd: Interactive directory jumper
fcd() {
    local dir=$(fd --type d --hidden --exclude .git | fzf --preview 'lsd --tree --depth 2 {}')
    [[ -n "$dir" ]] && cd "$dir"
}

# edot: Chezmoi wrapper to edit dotfiles
edot() {
    local file=${1:-~/.zshrc}
    chezmoi edit --apply "$file"
}

# ghp: GitHub repository manager
ghp() {
    local repo=$(gh repo list --limit 100 --json fullName,description --jq '.[] | [.fullName, .description] | @tsv' | \
        fzf --delimiter $'\t' --preview "gh repo view {1}" --height 70% --layout=reverse | cut -f1)
    if [[ -n "$repo" ]]; then
        echo "1) Clone | 2) Browse | 3) Cancel"
        read "choice?Choice: "
        case $choice in
            1) git clone "https://github.com/$repo.git" ;;
            2) gh browse "$repo" ;;
        esac
    fi
}

# --- 12. FINAL INITIALIZATION ---

# Load p10k config
[[ ! -f ~/.p10k.zsh ]] || source ~/.p10k.zsh 2>/dev/null

# Load local overrides (Unfollowed by Git)
[[ -f ~/.zshrc_local ]] && source ~/.zshrc_local 2>/dev/null

